# Cleanup Adhoc GHCR Images
#
# This workflow automatically deletes adhoc GHCR images when a PR is closed.
# Adhoc images are temporary testing images pushed during PR development.
#
# Tag format: adhoc-{sanitized-branch-name}-{version}

name: Cleanup adhoc GHCR images

on:
  pull_request:
    types: [closed]

permissions:
  packages: write

env:
  GHCR_ORG: posit-dev

jobs:
  cleanup:
    runs-on: ubuntu-latest
    name: cleanup-adhoc-images
    strategy:
      fail-fast: false
      matrix:
        package: [team-operator, flightdeck]
    steps:
      - name: Compute tag prefix from branch name
        id: tag-prefix
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | tr '/' '-')
          TAG_PREFIX="adhoc-${SANITIZED_BRANCH}-"
          echo "prefix=$TAG_PREFIX" >> $GITHUB_OUTPUT
          echo "Cleaning up tags with prefix: $TAG_PREFIX"

      - name: Delete adhoc package versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE: ${{ matrix.package }}
          TAG_PREFIX: ${{ steps.tag-prefix.outputs.prefix }}
        run: |
          echo "Looking for versions of $PACKAGE with tag prefix: $TAG_PREFIX"

          # List all versions and find ones with matching adhoc tags
          VERSIONS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/orgs/${{ env.GHCR_ORG }}/packages/container/${PACKAGE}/versions" \
            --paginate \
            --jq ".[] | select(.metadata.container.tags[] | startswith(\"$TAG_PREFIX\")) | .id" \
            2>/dev/null || echo "")

          if [ -z "$VERSIONS" ]; then
            echo "No adhoc versions found with prefix: $TAG_PREFIX"
            exit 0
          fi

          DELETED=0
          for VERSION_ID in $VERSIONS; do
            echo "Deleting version ID: $VERSION_ID"
            if gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/${{ env.GHCR_ORG }}/packages/container/${PACKAGE}/versions/${VERSION_ID}" \
              2>/dev/null; then
              DELETED=$((DELETED + 1))
            else
              echo "Warning: Failed to delete version $VERSION_ID (may be the last tagged version)"
            fi
          done

          echo "Deleted $DELETED adhoc version(s)"

      - name: Summary
        run: |
          echo "### Adhoc Image Cleanup: ${{ matrix.package }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag prefix:** \`${{ steps.tag-prefix.outputs.prefix }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** \`ghcr.io/${{ env.GHCR_ORG }}/${{ matrix.package }}\`" >> $GITHUB_STEP_SUMMARY
