# Connect Configuration Guide

This comprehensive guide covers all configuration options for Posit Connect when deployed via Team Operator.

## Table of Contents

1. [Overview](#overview)
2. [Basic Configuration](#basic-configuration)
3. [Authentication Configuration](#authentication-configuration)
4. [Database Configuration](#database-configuration)
5. [Off-Host Execution / Kubernetes Launcher](#off-host-execution--kubernetes-launcher)
6. [GPU Support](#gpu-support)
7. [Content Execution Settings](#content-execution-settings)
8. [Chronicle Integration](#chronicle-integration)
9. [SMTP/Email Configuration](#smtpemail-configuration-experimental)
10. [Data Integrations](#data-integrations)
11. [Experimental Features](#experimental-features)
12. [Example Configurations](#example-configurations)
13. [Troubleshooting](#troubleshooting)

---

## Overview

Posit Connect is a publishing and sharing platform that allows data scientists to share their work with stakeholders. When deployed via Team Operator, Connect runs with off-host execution enabled by default, meaning content executes in isolated Kubernetes Jobs rather than on the Connect server itself.

### Architecture in Team Operator

```
Site CR
    |
    +-> Connect CR (generated by Site controller)
            |
            +-> Deployment (Connect server)
            |       +-> Chronicle sidecar (telemetry)
            |
            +-> Service (ClusterIP)
            +-> Ingress (external access)
            +-> ConfigMap (rstudio-connect.gcfg, runtime.yaml)
            +-> PVC (data storage)
            +-> ServiceAccount (for Kubernetes launcher)
            +-> RBAC (roles/rolebindings for session jobs)
            +-> Session Jobs (content execution - on demand)
```

### Configuration Flow

Configuration for Connect flows through two paths:

1. **Site-level configuration** (`spec.connect` in Site CR) - Recommended for most deployments
2. **Direct Connect CR configuration** - For advanced use cases

When using a Site resource, the Site controller generates and manages the Connect CR. Changes to `site.spec.connect` automatically propagate to the Connect deployment.

---

## Basic Configuration

### Image Configuration

```yaml
spec:
  connect:
    # Container image for Connect server
    image: "ghcr.io/posit-dev/connect:ubuntu22-2024.10.0"

    # Image pull policy: Always, IfNotPresent, Never
    imagePullPolicy: IfNotPresent

    # Session image for content execution (init container)
    sessionImage: "ghcr.io/rstudio/rstudio-connect-content-init:ubuntu2204-2024.06.0"
```

**Important:** The `sessionImage` is used as an init container in content execution jobs. It prepares the runtime environment before content runs.

### Resource Scaling

```yaml
spec:
  connect:
    # Number of Connect server replicas
    replicas: 2
```

The operator automatically creates a PodDisruptionBudget based on replica count to ensure availability during updates.

### Domain and Ingress

```yaml
spec:
  domain: example.mycompany.com

  connect:
    # URL subdomain prefix (default: "connect")
    domainPrefix: connect  # Results in connect.example.mycompany.com

  # Ingress class for routing
  ingressClass: traefik

  # Ingress annotations (applied to Connect ingress)
  ingressAnnotations:
    traefik.ingress.kubernetes.io/router.middlewares: kube-system-forward-auth@kubernetescrd
```

### Node Selection

```yaml
spec:
  connect:
    nodeSelector:
      node-type: posit-products
      workload: connect
```

### Additional Environment Variables

```yaml
spec:
  connect:
    addEnv:
      CONNECT_CUSTOM_VAR: "custom-value"
      HTTP_PROXY: "http://proxy.example.com:8080"
      HTTPS_PROXY: "http://proxy.example.com:8080"
      NO_PROXY: "localhost,127.0.0.1,.cluster.local"
```

### Volume Configuration

Connect requires persistent storage for its data directory (`/var/lib/rstudio-connect`):

```yaml
spec:
  connect:
    volume:
      # Create a new PVC for Connect
      create: true

      # Access modes for the PVC
      accessModes:
        - ReadWriteMany

      # Storage size
      size: "10Gi"

      # Storage class name
      storageClassName: "efs-sc"

      # Reference existing PV (optional)
      volumeName: "existing-pv-name"
```

For existing PVCs:

```yaml
spec:
  connect:
    volume:
      create: false
      pvcName: "existing-connect-pvc"
```

### License Configuration

```yaml
spec:
  connect:
    license:
      # License type: FILE or KEY
      type: FILE

      # Reference to existing Kubernetes secret containing license
      existingSecretName: "posit-licenses"
      existingSecretKey: "connect.lic"
```

For inline license key (not recommended for production):

```yaml
spec:
  connect:
    license:
      type: KEY
      key: "XXXX-XXXX-XXXX-XXXX-XXXX-XXXX-XXXX"
```

### Warning Messages

Display warning messages to users on the Connect dashboard:

```yaml
spec:
  connect:
    # Warning shown to logged-in users
    loggedInWarning: "This is a development environment. Data may be deleted."

    # Warning shown to all visitors (including anonymous)
    publicWarning: "For authorized use only."
```

---

## Authentication Configuration

Connect supports multiple authentication providers. Authentication is configured through the `auth` section.

### OIDC Authentication (Recommended)

```yaml
spec:
  connect:
    auth:
      type: "oidc"

      # Required: OAuth2 client ID from your IdP
      clientId: "connect-client-id"

      # Required: OpenID Connect issuer URL
      issuer: "https://idp.example.com/realms/posit"

      # Enable group synchronization
      groups: true

      # Custom OAuth scopes (optional)
      scopes:
        - "openid"
        - "profile"
        - "email"
        - "groups"

      # Claim mappings (optional - override defaults)
      usernameClaim: "preferred_username"
      emailClaim: "email"
      uniqueIdClaim: "sub"
      groupsClaim: "groups"

      # Disable groups claim entirely (when IdP doesn't support it)
      disableGroupsClaim: false
```

**Client Secret:** The OIDC client secret must be stored in your secret backend:
- For Kubernetes secrets: Key `pub-client-secret` in the secret specified by `spec.secret.vaultName`
- For AWS Secrets Manager: Key `pub-client-secret` in the vault

### SAML Authentication

```yaml
spec:
  connect:
    auth:
      type: "saml"

      # Required: IdP metadata URL
      samlMetadataUrl: "https://idp.example.com/metadata"

      # Option 1: Use a predefined profile
      samlIdPAttributeProfile: "azure"  # or "okta", "default"

      # Option 2: Custom attribute mappings (mutually exclusive with profile)
      # samlUsernameAttribute: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"
      # samlFirstNameAttribute: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname"
      # samlLastNameAttribute: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname"
      # samlEmailAttribute: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
```

**Note:** `samlIdPAttributeProfile` and individual SAML attribute mappings are mutually exclusive. The controller will reject configurations that specify both.

### Password Authentication

For development or isolated environments:

```yaml
spec:
  connect:
    auth:
      type: "password"
```

### Role Mappings

Map IdP groups to Connect roles (works with both OIDC and SAML when groups are enabled):

```yaml
spec:
  connect:
    auth:
      type: "oidc"
      groups: true

      # Map groups to Connect roles
      viewerRoleMapping:
        - "connect-viewers"
        - "data-consumers"

      publisherRoleMapping:
        - "connect-publishers"
        - "data-scientists"

      administratorRoleMapping:
        - "connect-admins"
        - "platform-admins"
```

---

## Database Configuration

Connect requires PostgreSQL for storing application metadata, user information, and content settings.

### Basic Database Settings

Database connection is automatically configured based on your Site's database credentials secret. You can customize the schema names:

```yaml
spec:
  connect:
    databaseSettings:
      # Main database schema (default: "connect")
      schema: "connect"

      # Instrumentation/metrics schema (default: "instrumentation")
      instrumentationSchema: "connect_instrumentation"
```

### Database URL Construction

The operator constructs database URLs automatically:

```
postgresql://user:password@host/connect-db?search_path=connect&sslmode=require
postgresql://user:password@host/connect-db?search_path=connect_instrumentation&sslmode=require
```

The password is injected via environment variable `CONNECT_POSTGRES_PASSWORD` from your secret backend.

### Secret Backend Configuration

```yaml
spec:
  # For Kubernetes secrets
  secret:
    type: "kubernetes"
    vaultName: "site-secrets"  # Must contain key: pub-db-password

  # For AWS Secrets Manager
  # secret:
  #   type: "aws"
  #   vaultName: "production-site-secrets"

  # Database credentials (separate from site secrets)
  mainDatabaseCredentialSecret:
    type: "aws"
    vaultName: "rds!db-production-id"
```

---

## Off-Host Execution / Kubernetes Launcher

Off-host execution is **enabled by default** when Connect is deployed via Team Operator. Content runs in isolated Kubernetes Jobs rather than on the Connect server.

### How It Works

1. User requests content (Shiny app, API, report)
2. Connect server creates a Kubernetes Job
3. Job runs with appropriate runtime image (R, Python, Quarto)
4. Content executes in the Job pod
5. Job terminates when content completes or times out

### Session Configuration

Customize session pods via `sessionConfig`:

```yaml
apiVersion: core.posit.team/v1beta1
kind: Connect
metadata:
  name: example
spec:
  sessionConfig:
    # Service configuration for session networking
    service:
      type: ClusterIP
      labels:
        custom-label: value

    # Pod configuration for session jobs
    pod:
      annotations:
        prometheus.io/scrape: "true"

      labels:
        session-type: connect-content

      # Service account for session pods
      serviceAccountName: "connect-session"

      # Image pull settings
      imagePullPolicy: Always
      imagePullSecrets:
        - name: ghcr-secret

      # Environment variables for sessions
      env:
        - name: CUSTOM_VAR
          value: "session-value"
        - name: SECRET_VAR
          valueFrom:
            secretKeyRef:
              name: session-secrets
              key: api-key

      # Additional volumes for session pods
      volumes:
        - name: shared-data
          persistentVolumeClaim:
            claimName: shared-data-pvc

      # Volume mounts for session containers
      volumeMounts:
        - name: shared-data
          mountPath: /mnt/shared

      # Node selection for sessions
      nodeSelector:
        workload: connect-sessions

      # Tolerations for session pods
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "connect-sessions"
          effect: "NoSchedule"

      # Affinity rules
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: workload
                    operator: In
                    values:
                      - connect-sessions

      # Priority class for session scheduling
      priorityClassName: "connect-sessions"

      # Init containers (in addition to runtime init)
      initContainers:
        - name: setup-cache
          image: busybox
          command: ["sh", "-c", "mkdir -p /cache && chmod 777 /cache"]

      # Sidecar containers
      extraContainers:
        - name: log-shipper
          image: fluent/fluent-bit
          volumeMounts:
            - name: logs
              mountPath: /var/log

    # Job-level configuration
    job:
      labels:
        job-type: connect-content
```

### Session Images (Runtime Configuration)

Connect uses runtime images for content execution. The default runtime.yaml includes two image configurations:

```yaml
# Default runtime images (auto-generated)
name: Kubernetes
images:
  - name: ghcr.io/rstudio/content-pro:r4.4.1-py3.12.4-ubuntu2204
    python:
      installations:
        - path: /opt/python/3.12.4/bin/python3
          version: "3.12.4"
    r:
      installations:
        - path: /opt/R/4.4.1/bin/R
          version: "4.4.1"
    quarto:
      installations:
        - path: /opt/quarto/1.4.557/bin/quarto
          version: "1.4.557"

  - name: ghcr.io/rstudio/content-pro:r4.2.2-py3.11.3-ubuntu2204
    python:
      installations:
        - path: /opt/python/3.11.3/bin/python3
          version: "3.11.3"
    r:
      installations:
        - path: /opt/R/4.2.2/bin/R
          version: "4.2.2"
    quarto:
      installations:
        - path: /opt/quarto/1.3.340/bin/quarto
          version: "1.3.340"
```

**Custom Runtime Images:** To add custom runtime images, you need to modify the Connect CR directly (advanced use case) or use the Connect admin interface after deployment.

### Additional Volumes for Sessions

Mount additional volumes into session pods:

```yaml
spec:
  connect:
    # Site-level additional volumes (applied to main Connect and sessions)
    additionalVolumes:
      - pvcName: shared-datasets
        mountPath: /mnt/datasets
        readOnly: true
        create: false  # Use existing PVC

      - pvcName: project-data
        mountPath: /mnt/projects
        readOnly: false
        create: true  # Create new PVC
        size: "100Gi"
        storageClassName: "efs-sc"
        accessModes:
          - ReadWriteMany
```

---

## GPU Support

Connect supports both NVIDIA and AMD GPUs for content execution.

### NVIDIA GPU Configuration

```yaml
spec:
  connect:
    gpuSettings:
      # Default GPU limit for new content
      nvidiaGPULimit: 1

      # Maximum GPU limit users can request
      maxNvidiaGPULimit: 4
```

This configures the Connect scheduler to:
- Allow content to request NVIDIA GPUs
- Set default allocation to 1 GPU
- Cap maximum allocation at 4 GPUs

### AMD GPU Configuration

```yaml
spec:
  connect:
    gpuSettings:
      # Default AMD GPU limit
      amdGPULimit: 1

      # Maximum AMD GPU limit
      maxAMDGPULimit: 2
```

### Combined Configuration

```yaml
spec:
  connect:
    gpuSettings:
      nvidiaGPULimit: 1
      maxNvidiaGPULimit: 8
      amdGPULimit: 0
      maxAMDGPULimit: 4
```

### Prerequisites for GPU Support

1. **GPU Nodes:** Your cluster must have nodes with GPUs and appropriate drivers
2. **Device Plugin:** NVIDIA or AMD device plugin must be installed
3. **GPU Images:** Content runtime images must include GPU libraries (CUDA, ROCm)
4. **Node Selection:** Configure session tolerations/affinity to schedule on GPU nodes

Example session configuration for GPU nodes:

```yaml
spec:
  sessionConfig:
    pod:
      tolerations:
        - key: "nvidia.com/gpu"
          operator: "Exists"
          effect: "NoSchedule"
      nodeSelector:
        accelerator: nvidia-gpu
```

---

## Content Execution Settings

### Scheduler Configuration

Control resource limits for content execution:

```yaml
spec:
  connect:
    # Schedule concurrency - max concurrent scheduled jobs
    scheduleConcurrency: 2  # Default: 2
```

The default scheduler configuration includes:

| Setting | Default Value | Description |
|---------|---------------|-------------|
| MaxCPURequest | 4 | Maximum CPU cores content can request |
| MaxCPULimit | 4 | Maximum CPU cores content can use |
| MaxMemoryRequest | 8GB | Maximum memory content can request |
| MaxMemoryLimit | 8GB | Maximum memory content can use |

These are set internally by the operator and can be adjusted via Connect admin settings after deployment.

### Application Settings

The operator configures sensible defaults for applications:

```yaml
# Internal configuration (for reference)
Applications:
  BundleRetentionLimit: 2        # Keep last 2 bundle versions
  PythonEnvironmentReaping: true  # Clean up unused Python envs
  OAuthIntegrationsEnabled: true  # Allow OAuth integrations in content
  ScheduleConcurrency: 2          # From scheduleConcurrency setting
```

### Authorization Defaults

```yaml
# Internal authorization defaults
Authorization:
  DefaultUserRole: publisher           # New users get publisher role
  PublishersCanManageVanities: true   # Publishers can set custom URLs
  ViewersCanOnlySeeThemselves: false  # Viewers can see other users
```

---

## Chronicle Integration

Chronicle provides telemetry and metrics collection for Connect. When configured, a Chronicle agent sidecar is automatically injected into the Connect deployment.

### Enabling Chronicle

Chronicle is enabled when both `chronicle.image` and `chronicle.agentImage` are set at the Site level:

```yaml
spec:
  chronicle:
    # Main Chronicle server image
    image: "ghcr.io/posit-dev/chronicle:2024.11.0"

    # Chronicle agent image (injected into products)
    agentImage: "ghcr.io/posit-dev/chronicle-agent:latest"

    # S3 bucket for telemetry storage
    s3Bucket: "my-chronicle-bucket"
```

### Chronicle Sidecar Behavior

The Chronicle agent sidecar:
- Collects metrics from Connect's Prometheus endpoint (`:3232/metrics`)
- Sends telemetry to the Chronicle server
- Runs alongside the main Connect container

### Product API Key (Experimental)

For authenticated telemetry:

```yaml
spec:
  connect:
    experimentalFeatures:
      chronicleSidecarProductApiKeyEnabled: true
```

This requires a secret `pub-chronicle-api-key` in your secret backend.

---

## SMTP/Email Configuration (Experimental)

Enable email notifications from Connect for scheduled reports and user notifications.

```yaml
spec:
  connect:
    experimentalFeatures:
      # Sender email address (enables SMTP)
      mailSender: "connect@example.com"

      # Display name in email subject
      mailDisplayName: "Posit Connect"

      # Target email for testing (optional - routes all email here)
      mailTarget: "test@example.com"
```

### SMTP Secrets

SMTP credentials must be stored in your secret backend with these keys:

| Key | Description |
|-----|-------------|
| `pub-smtp-host` | SMTP server hostname |
| `pub-smtp-port` | SMTP server port |
| `pub-smtp-user` | SMTP username |
| `pub-smtp-password` | SMTP password |

For AWS Secrets Manager, these keys are automatically mapped to the `<site>-connect-smtp` Kubernetes secret.

### Email Configuration Notes

- SMTP is considered **experimental** in Team Operator
- For production email, consider using Connect's built-in email configuration after deployment
- The `mailTarget` setting is useful for testing to prevent accidental emails to real users

---

## Data Integrations

### Databricks Integration

Configure Databricks connectivity for content:

```yaml
spec:
  connect:
    databricks:
      # Human-readable name
      name: "Production Databricks"

      # Workspace URL
      url: "https://example-workspace.cloud.databricks.com"

      # OAuth client ID for service principal
      clientId: "databricks-client-id"

      # Azure tenant ID (for Azure Databricks)
      tenantId: "azure-tenant-id"
```

### DSN/ODBC Secrets

Mount ODBC configuration files into Connect sessions for database connectivity:

```yaml
spec:
  connect:
    experimentalFeatures:
      # Reference to DSN secret key in your secret backend
      dsnSecret: "connect-odbc-config"
```

The DSN secret should contain an `odbc.ini` file content:

```ini
[MyDatabase]
Driver = PostgreSQL
Server = db.example.com
Port = 5432
Database = analytics
```

This mounts to `/etc/odbc.ini` in session pods.

---

## Experimental Features

All experimental features are configured under `experimentalFeatures`:

```yaml
spec:
  connect:
    experimentalFeatures:
      # SMTP configuration
      mailSender: "connect@example.com"
      mailDisplayName: "Posit Connect"
      mailTarget: ""

      # DSN/ODBC configuration
      dsnSecret: "odbc-config-key"

      # Session configuration
      sessionEnvVars:
        - name: CUSTOM_SESSION_VAR
          value: "value"
        - name: SECRET_VAR
          valueFrom:
            secretKeyRef:
              name: session-secrets
              key: api-key

      sessionImagePullPolicy: Always

      # Override default session service account
      sessionServiceAccountName: "custom-connect-session"

      # Chronicle product API key
      chronicleSidecarProductApiKeyEnabled: false
```

### Session Environment Variables

Inject custom environment variables into all content execution sessions:

```yaml
spec:
  connect:
    experimentalFeatures:
      sessionEnvVars:
        # Simple value
        - name: ENVIRONMENT
          value: "production"

        # From ConfigMap
        - name: CONFIG_VALUE
          valueFrom:
            configMapKeyRef:
              name: connect-config
              key: config-value

        # From Secret
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: connect-secrets
              key: api-key

        # AWS Secrets Manager reference (with secret:// prefix)
        - name: DB_PASSWORD
          value: "secret://db-password-key"
```

**Note:** The `secret://` prefix is special - it triggers the operator to create CSI secret mounts for AWS Secrets Manager values.

---

## Example Configurations

### Minimal Development Configuration

```yaml
apiVersion: core.posit.team/v1beta1
kind: Site
metadata:
  name: dev
  namespace: posit-team
spec:
  domain: dev.example.com

  secret:
    type: "kubernetes"
    vaultName: "dev-secrets"

  mainDatabaseCredentialSecret:
    type: "kubernetes"
    vaultName: "dev-db-creds"

  connect:
    image: ghcr.io/posit-dev/connect:ubuntu22-2024.10.0
    replicas: 1

    license:
      type: FILE
      existingSecretName: posit-licenses
      existingSecretKey: connect.lic

    auth:
      type: "password"
```

### Production Configuration with OIDC

```yaml
apiVersion: core.posit.team/v1beta1
kind: Site
metadata:
  name: production
  namespace: posit-team
spec:
  domain: posit.example.com
  awsAccountId: "123456789012"

  secret:
    type: "aws"
    vaultName: "production-posit-secrets"

  mainDatabaseCredentialSecret:
    type: "aws"
    vaultName: "rds!db-production-id"

  ingressClass: traefik

  volumeSource:
    type: fsx-zfs
    volumeId: fsvol-abcdef123456
    dnsName: fs-abcdef123456.fsx.us-east-1.amazonaws.com

  connect:
    image: ghcr.io/posit-dev/connect:ubuntu22-2024.10.0
    replicas: 3

    license:
      type: FILE
      existingSecretName: posit-licenses
      existingSecretKey: connect.lic

    auth:
      type: "oidc"
      clientId: "connect-production"
      issuer: "https://idp.example.com"
      groups: true
      viewerRoleMapping:
        - "connect-viewers"
      publisherRoleMapping:
        - "connect-publishers"
      administratorRoleMapping:
        - "connect-admins"

    nodeSelector:
      workload: posit-products

    databaseSettings:
      schema: "connect"
      instrumentationSchema: "connect_metrics"

    gpuSettings:
      nvidiaGPULimit: 1
      maxNvidiaGPULimit: 4

    scheduleConcurrency: 4

    databricks:
      name: "Production Workspace"
      url: "https://workspace.cloud.databricks.com"
      clientId: "databricks-oauth-client"

    experimentalFeatures:
      mailSender: "connect@example.com"
      mailDisplayName: "Posit Connect Production"
```

### GPU-Enabled Configuration

```yaml
apiVersion: core.posit.team/v1beta1
kind: Site
metadata:
  name: gpu-workloads
  namespace: posit-team
spec:
  domain: gpu.example.com

  secret:
    type: "kubernetes"
    vaultName: "gpu-site-secrets"

  mainDatabaseCredentialSecret:
    type: "kubernetes"
    vaultName: "gpu-db-creds"

  connect:
    image: ghcr.io/posit-dev/connect:ubuntu22-2024.10.0
    replicas: 2
    sessionImage: ghcr.io/rstudio/rstudio-connect-content-init:gpu-ubuntu2204-2024.06.0

    license:
      type: FILE
      existingSecretName: posit-licenses
      existingSecretKey: connect.lic

    auth:
      type: "oidc"
      clientId: "connect-gpu"
      issuer: "https://idp.example.com"

    gpuSettings:
      nvidiaGPULimit: 1
      maxNvidiaGPULimit: 8

    experimentalFeatures:
      sessionEnvVars:
        - name: CUDA_VISIBLE_DEVICES
          value: "all"
```

### Multi-Schema Database Configuration

```yaml
spec:
  connect:
    databaseSettings:
      # Separate schemas for different concerns
      schema: "connect_main"
      instrumentationSchema: "connect_telemetry"
```

---

## Troubleshooting

### Connect Pod Not Starting

1. **Check pod status:**
   ```bash
   kubectl get pods -n posit-team -l app.kubernetes.io/name=connect
   kubectl describe pod <connect-pod-name> -n posit-team
   ```

2. **Check logs:**
   ```bash
   kubectl logs -n posit-team deploy/<site-name>-connect -c connect
   kubectl logs -n posit-team deploy/<site-name>-connect -c chronicle
   ```

3. **Common issues:**
   - License not found: Check license secret exists and key is correct
   - Database connection failed: Verify database credentials and connectivity
   - Volume mount failed: Ensure PVC exists and storage class is available

### Content Sessions Not Running

1. **Check session jobs:**
   ```bash
   kubectl get jobs -n posit-team -l posit.team/component=connect-session
   ```

2. **Check session pod logs:**
   ```bash
   kubectl logs -n posit-team job/<session-job-name>
   ```

3. **Common issues:**
   - Init container failed: Check session image is accessible
   - Runtime not found: Verify runtime.yaml configuration
   - Resource limits exceeded: Check scheduler limits

### Authentication Failures

1. **For OIDC:**
   - Verify client ID and issuer URL
   - Check client secret is in the correct secret backend
   - Ensure redirect URIs are configured in your IdP
   - Enable debug logging: `spec.debug: true`

2. **For SAML:**
   - Verify metadata URL is accessible
   - Check attribute mappings match your IdP
   - Review Connect logs for SAML assertion errors

### Database Connection Issues

1. **Verify database secret:**
   ```bash
   # For Kubernetes secrets
   kubectl get secret <vault-name> -n posit-team -o yaml

   # Check the pub-db-password key exists
   ```

2. **Test database connectivity:**
   ```bash
   kubectl exec -it <connect-pod> -n posit-team -- \
     psql "postgresql://user@host/db?sslmode=require"
   ```

3. **Check database URL in Connect logs:**
   Look for connection string format errors

### Chronicle Sidecar Issues

1. **Verify Chronicle is configured:**
   ```bash
   kubectl get pods -n posit-team -l app.kubernetes.io/name=connect -o yaml | grep chronicle
   ```

2. **Check Chronicle agent logs:**
   ```bash
   kubectl logs -n posit-team deploy/<site-name>-connect -c chronicle
   ```

3. **Common issues:**
   - Missing `agentImage`: Chronicle sidecar won't be created
   - Network policy blocking: Ensure Chronicle server is reachable

### GPU Sessions Not Scheduling

1. **Check GPU availability:**
   ```bash
   kubectl describe nodes | grep -A5 "nvidia.com/gpu"
   ```

2. **Verify device plugin:**
   ```bash
   kubectl get pods -n kube-system | grep nvidia
   ```

3. **Check session tolerations match GPU node taints**

### Debug Mode

Enable comprehensive debug logging:

```yaml
spec:
  debug: true  # Site-level debug

  connect:
    # This is set automatically when site.spec.debug is true
```

Debug mode enables:
- ServiceLogLevel: DEBUG
- OAuth2.Logging: true
- TableauIntegration.Logging: true
- ProxyHeaderLogging: true

### Viewing Generated Configuration

To see the actual Connect configuration:

```bash
kubectl get configmap <site-name>-connect -n posit-team -o yaml
```

This shows:
- `rstudio-connect.gcfg`: Main Connect configuration
- `runtime.yaml`: Runtime/session image configuration
- `launcher.kubernetes.profiles.conf`: Launcher profiles

---

## Related Documentation

- [Site Management Guide](product-team-site-management.md) - Overall Site configuration
- [Adding Config Options](adding-config-options.md) - For contributors extending Connect configuration
- [Posit Connect Admin Guide](https://docs.posit.co/connect/admin/) - Official Connect documentation
